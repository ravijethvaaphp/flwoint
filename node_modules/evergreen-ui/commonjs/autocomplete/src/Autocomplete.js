"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _fuzzaldrinPlus = _interopRequireDefault(require("fuzzaldrin-plus"));

var _downshift = _interopRequireDefault(require("downshift"));

var _reactTinyVirtualList = _interopRequireDefault(require("react-tiny-virtual-list"));

var _popover = require("../../popover");

var _constants = require("../../constants");

var _typography = require("../../typography");

var _layers = require("../../layers");

var _deprecated = _interopRequireDefault(require("../../lib/deprecated"));

var _AutocompleteItem = _interopRequireDefault(require("./AutocompleteItem"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fuzzyFilter = function fuzzyFilter(itemToString) {
  if (itemToString) {
    return function (items, input) {
      var wrappedItems = items.map(function (item) {
        return {
          key: itemToString(item),
          item: item
        };
      });
      return _fuzzaldrinPlus["default"].filter(wrappedItems, input, {
        key: 'key'
      }).map(function (_ref) {
        var item = _ref.item;
        return item;
      });
    };
  }

  return function (items, input) {
    return _fuzzaldrinPlus["default"].filter(items, input);
  };
};

var noop = function noop() {};

var autocompleteItemRenderer = function autocompleteItemRenderer(props) {
  return _react["default"].createElement(_AutocompleteItem["default"], props);
};

autocompleteItemRenderer.displayName = "autocompleteItemRenderer";

// https://github.com/paypal/downshift/issues/164
var Autocomplete =
/*#__PURE__*/
function (_PureComponent) {
  (0, _inherits2["default"])(Autocomplete, _PureComponent);

  function Autocomplete() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2["default"])(this, Autocomplete);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2["default"])(this, (_getPrototypeOf2 = (0, _getPrototypeOf3["default"])(Autocomplete)).call.apply(_getPrototypeOf2, [this].concat(args)));
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "state", {
      targetWidth: 0
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "stateReducer", function (state, changes) {
      var items = _this.props.items;

      if (Object.prototype.hasOwnProperty.call(changes, 'isOpen') && changes.isOpen) {
        return _objectSpread({}, changes, {
          highlightedIndex: items.indexOf(state.selectedItem)
        });
      }

      return changes;
    });
    (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "renderResults", function (_ref2) {
      var width = _ref2.width,
          inputValue = _ref2.inputValue,
          highlightedIndex = _ref2.highlightedIndex,
          selectedItem = _ref2.selectedItem,
          getItemProps = _ref2.getItemProps,
          getMenuProps = _ref2.getMenuProps;
      var _this$props = _this.props,
          title = _this$props.title,
          itemSize = _this$props.itemSize,
          itemsFilter = _this$props.itemsFilter,
          originalItems = _this$props.items,
          itemToString = _this$props.itemToString,
          _renderItem = _this$props.renderItem,
          popoverMaxHeight = _this$props.popoverMaxHeight,
          isFilterDisabled = _this$props.isFilterDisabled;
      var filter = itemsFilter || fuzzyFilter(itemToString);
      var items = isFilterDisabled || inputValue.trim() === '' ? originalItems : filter(originalItems, inputValue);
      if (items.length === 0) return null; // Pass the actual DOM ref to downshift, this fixes touch support

      var menuProps = getMenuProps();
      menuProps.innerRef = menuProps.ref;
      delete menuProps.ref;
      return _react["default"].createElement(_layers.Pane, (0, _extends2["default"])({
        width: width
      }, menuProps), title && _react["default"].createElement(_layers.Pane, {
        padding: 8,
        borderBottom: "muted"
      }, _react["default"].createElement(_typography.Heading, {
        size: 100
      }, title)), items.length > 0 && _react["default"].createElement(_reactTinyVirtualList["default"], {
        width: "100%",
        height: Math.min(items.length * itemSize, popoverMaxHeight),
        itemSize: itemSize,
        itemCount: items.length,
        scrollToIndex: highlightedIndex || 0,
        overscanCount: 3,
        scrollToAlignment: "auto",
        renderItem: function renderItem(_ref3) {
          var index = _ref3.index,
              style = _ref3.style;
          var item = items[index];
          var itemString = itemToString(item);
          return _renderItem(getItemProps({
            item: item,
            key: itemString,
            index: index,
            style: style,
            children: itemString,
            isSelected: itemToString(selectedItem) === itemString,
            isHighlighted: highlightedIndex === index
          }));
        }
      }));
    });
    return _this;
  }

  (0, _createClass2["default"])(Autocomplete, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      this.setState({
        targetWidth: this.targetRef.getBoundingClientRect().width
      });
    }
  }, {
    key: "render",
    value: function render() {
      var _this2 = this;

      var _this$props2 = this.props,
          children = _this$props2.children,
          itemSize = _this$props2.itemSize,
          position = _this$props2.position,
          renderItem = _this$props2.renderItem,
          itemsFilter = _this$props2.itemsFilter,
          popoverMaxHeight = _this$props2.popoverMaxHeight,
          popoverMinWidth = _this$props2.popoverMinWidth,
          defaultSelectedItem = _this$props2.defaultSelectedItem,
          initialSelectedItem = _this$props2.initialSelectedItem,
          defaultInputValue = _this$props2.defaultInputValue,
          initialInputValue = _this$props2.initialInputValue,
          getButtonProps = _this$props2.getButtonProps,
          getToggleButtonProps = _this$props2.getToggleButtonProps,
          props = (0, _objectWithoutProperties2["default"])(_this$props2, ["children", "itemSize", "position", "renderItem", "itemsFilter", "popoverMaxHeight", "popoverMinWidth", "defaultSelectedItem", "initialSelectedItem", "defaultInputValue", "initialInputValue", "getButtonProps", "getToggleButtonProps"]);
      return _react["default"].createElement(_downshift["default"], (0, _extends2["default"])({
        initialSelectedItem: initialSelectedItem || defaultSelectedItem,
        initialInputValue: initialInputValue || defaultInputValue,
        getToggleButtonProps: getToggleButtonProps || getButtonProps,
        stateReducer: this.stateReducer,
        scrollIntoView: noop
      }, props), function (_ref4) {
        var isShown = _ref4.isOpen,
            inputValue = _ref4.inputValue,
            getItemProps = _ref4.getItemProps,
            getMenuProps = _ref4.getMenuProps,
            selectedItem = _ref4.selectedItem,
            highlightedIndex = _ref4.highlightedIndex,
            getRootProps = _ref4.getRootProps,
            restDownshiftProps = (0, _objectWithoutProperties2["default"])(_ref4, ["isOpen", "inputValue", "getItemProps", "getMenuProps", "selectedItem", "highlightedIndex", "getRootProps"]);
        return _react["default"].createElement(_layers.Pane, (0, _extends2["default"])({
          width: "100%"
        }, getRootProps({
          refKey: 'innerRef'
        })), _react["default"].createElement(_popover.Popover, {
          bringFocusInside: false,
          isShown: isShown,
          minWidth: popoverMinWidth,
          position: position || (_this2.state.targetWidth < popoverMinWidth ? _constants.Position.BOTTOM_LEFT : _constants.Position.BOTTOM),
          content: function content() {
            return _this2.renderResults({
              width: Math.max(_this2.state.targetWidth, popoverMinWidth),
              inputValue: inputValue,
              getItemProps: getItemProps,
              getMenuProps: getMenuProps,
              selectedItem: selectedItem,
              highlightedIndex: highlightedIndex
            });
          },
          minHeight: 0,
          animationDuration: 0
        }, function (_ref5) {
          var isShownPopover = _ref5.isShown,
              toggle = _ref5.toggle,
              _getRef = _ref5.getRef;
          return children(_objectSpread({
            isShown: isShownPopover,
            toggle: toggle,
            getRef: function getRef(ref) {
              // Use the ref internally to determine the width
              _this2.targetRef = ref;

              _getRef(ref);
            },
            inputValue: inputValue,
            selectedItem: selectedItem,
            highlightedIndex: highlightedIndex
          }, restDownshiftProps));
        }));
      });
    }
  }]);
  return Autocomplete;
}(_react.PureComponent);

exports["default"] = Autocomplete;
Autocomplete.displayName = "Autocomplete";
(0, _defineProperty2["default"])(Autocomplete, "propTypes", _objectSpread({
  /**
   * This prop can be either a string or a Node.
   * It will provide a title for the items
   */
  title: _propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].node]),

  /**
   * An array of items to be used as options for the select
   */
  items: _propTypes["default"].array.isRequired,

  /**
   * The selected Item to be shown on the autocomplete
   */
  selectedItem: _propTypes["default"].any,

  /**
   * The selected item to be selected & shown by default on the autocomplete (deprecated)
   */
  defaultSelectedItem: (0, _deprecated["default"])(_propTypes["default"].any, 'Use "initialSelectedItem" instead.'),

  /**
   * The selected item to be selected & shown by default on the autocomplete (deprecated)
   */
  defaultInputValue: (0, _deprecated["default"])(_propTypes["default"].any, 'Use "initialInputValue" instead.'),

  /**
   * In case the array of items is not an array of strings,
   * this function is used on each item to return the string that will be shown on the filter
   */
  itemToString: _propTypes["default"].func.isRequired,

  /**
   * Function that will render the 'filter' component.
   */
  children: _propTypes["default"].func.isRequired,

  /**
   * The height of each item in the list
   * Because the list is virtualized this is required beforehand.
   */
  itemSize: _propTypes["default"].number,

  /**
   * Function that returns a component to render the item
   */
  renderItem: _propTypes["default"].func,

  /**
   * The position of the Popover the Autocomplete is rendered in.
   */
  position: _propTypes["default"].oneOf([_constants.Position.TOP, _constants.Position.TOP_LEFT, _constants.Position.TOP_RIGHT, _constants.Position.BOTTOM, _constants.Position.BOTTOM_LEFT, _constants.Position.BOTTOM_RIGHT, _constants.Position.LEFT, _constants.Position.RIGHT]),

  /**
   * A function that is used to filter the items.
   * It should return a subset of the initial items.
   * By default the "fuzzaldrin-plus" package is used.
   */
  itemsFilter: _propTypes["default"].func,

  /**
   * Prop that enables and disables filtering
   * True: Enables Filtering
   * False: Disables Filtering
   */
  isFilterDisabled: _propTypes["default"].bool,

  /**
   * Defines the minimum height the results container will be
   */
  popoverMinWidth: _propTypes["default"].number,

  /**
   * Defines the maximum height the results container will be
   */
  popoverMaxHeight: _propTypes["default"].number,

  /**
   * The selected item to be selected & shown by default on the autocomplete (deprecated)
   */
  getButtonProps: (0, _deprecated["default"])(_propTypes["default"].func, 'Use "getToggleButtonProps" instead.')
}, _downshift["default"].propTypes));
(0, _defineProperty2["default"])(Autocomplete, "defaultProps", {
  itemToString: function itemToString(i) {
    return i ? String(i) : '';
  },
  itemSize: 32,
  isFilterDisabled: false,
  popoverMinWidth: 240,
  popoverMaxHeight: 240,
  renderItem: autocompleteItemRenderer
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hdXRvY29tcGxldGUvc3JjL0F1dG9jb21wbGV0ZS5qcyJdLCJuYW1lcyI6WyJmdXp6eUZpbHRlciIsIml0ZW1Ub1N0cmluZyIsIml0ZW1zIiwiaW5wdXQiLCJ3cmFwcGVkSXRlbXMiLCJtYXAiLCJpdGVtIiwia2V5IiwiZnV6emFsZHJpbiIsImZpbHRlciIsIm5vb3AiLCJhdXRvY29tcGxldGVJdGVtUmVuZGVyZXIiLCJwcm9wcyIsIkF1dG9jb21wbGV0ZSIsInRhcmdldFdpZHRoIiwic3RhdGUiLCJjaGFuZ2VzIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiaXNPcGVuIiwiaGlnaGxpZ2h0ZWRJbmRleCIsImluZGV4T2YiLCJzZWxlY3RlZEl0ZW0iLCJ3aWR0aCIsImlucHV0VmFsdWUiLCJnZXRJdGVtUHJvcHMiLCJnZXRNZW51UHJvcHMiLCJ0aXRsZSIsIml0ZW1TaXplIiwiaXRlbXNGaWx0ZXIiLCJvcmlnaW5hbEl0ZW1zIiwicmVuZGVySXRlbSIsInBvcG92ZXJNYXhIZWlnaHQiLCJpc0ZpbHRlckRpc2FibGVkIiwidHJpbSIsImxlbmd0aCIsIm1lbnVQcm9wcyIsImlubmVyUmVmIiwicmVmIiwiTWF0aCIsIm1pbiIsImluZGV4Iiwic3R5bGUiLCJpdGVtU3RyaW5nIiwiY2hpbGRyZW4iLCJpc1NlbGVjdGVkIiwiaXNIaWdobGlnaHRlZCIsInNldFN0YXRlIiwidGFyZ2V0UmVmIiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwicG9zaXRpb24iLCJwb3BvdmVyTWluV2lkdGgiLCJkZWZhdWx0U2VsZWN0ZWRJdGVtIiwiaW5pdGlhbFNlbGVjdGVkSXRlbSIsImRlZmF1bHRJbnB1dFZhbHVlIiwiaW5pdGlhbElucHV0VmFsdWUiLCJnZXRCdXR0b25Qcm9wcyIsImdldFRvZ2dsZUJ1dHRvblByb3BzIiwic3RhdGVSZWR1Y2VyIiwiaXNTaG93biIsImdldFJvb3RQcm9wcyIsInJlc3REb3duc2hpZnRQcm9wcyIsInJlZktleSIsIlBvc2l0aW9uIiwiQk9UVE9NX0xFRlQiLCJCT1RUT00iLCJyZW5kZXJSZXN1bHRzIiwibWF4IiwiaXNTaG93blBvcG92ZXIiLCJ0b2dnbGUiLCJnZXRSZWYiLCJQdXJlQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwib25lT2ZUeXBlIiwic3RyaW5nIiwibm9kZSIsImFycmF5IiwiaXNSZXF1aXJlZCIsImFueSIsImZ1bmMiLCJudW1iZXIiLCJvbmVPZiIsIlRPUCIsIlRPUF9MRUZUIiwiVE9QX1JJR0hUIiwiQk9UVE9NX1JJR0hUIiwiTEVGVCIsIlJJR0hUIiwiYm9vbCIsIkRvd25zaGlmdCIsInByb3BUeXBlcyIsImkiLCJTdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLElBQU1BLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUFDLFlBQVksRUFBSTtBQUNsQyxNQUFJQSxZQUFKLEVBQWtCO0FBQ2hCLFdBQU8sVUFBQ0MsS0FBRCxFQUFRQyxLQUFSLEVBQWtCO0FBQ3ZCLFVBQU1DLFlBQVksR0FBR0YsS0FBSyxDQUFDRyxHQUFOLENBQVUsVUFBQUMsSUFBSTtBQUFBLGVBQUs7QUFDdENDLFVBQUFBLEdBQUcsRUFBRU4sWUFBWSxDQUFDSyxJQUFELENBRHFCO0FBRXRDQSxVQUFBQSxJQUFJLEVBQUpBO0FBRnNDLFNBQUw7QUFBQSxPQUFkLENBQXJCO0FBS0EsYUFBT0UsMkJBQ0pDLE1BREksQ0FDR0wsWUFESCxFQUNpQkQsS0FEakIsRUFDd0I7QUFBRUksUUFBQUEsR0FBRyxFQUFFO0FBQVAsT0FEeEIsRUFFSkYsR0FGSSxDQUVBO0FBQUEsWUFBR0MsSUFBSCxRQUFHQSxJQUFIO0FBQUEsZUFBY0EsSUFBZDtBQUFBLE9BRkEsQ0FBUDtBQUdELEtBVEQ7QUFVRDs7QUFFRCxTQUFPLFVBQUNKLEtBQUQs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QUFFdkI7Ozs7O0FBS0E5QyxFQUFBQSxnQkFBZ0IsRUFBRXVDLHNCQUFVZ0IsSTs7QUFFNUI7OztBQUdBckMsRUFBQUEsZUFBZSxFQUFFcUIsc0JBQVVRLE07O0FBRTNCOzs7QUFHQWhELEVBQUFBLGdCQUFnQixFQUFFd0Msc0JBQVVRLE07O0FBRTVCOzs7QUFHQXhCLEVBQUFBLGNBQWMsRUFBRSw0QkFDZGdCLHNCQUFVTyxJQURJLEVBRWQscUNBRmM7R0FLYlUsc0JBQVVDLFM7aUNBdEdJL0UsWSxrQkE2R0c7QUFDcEJaLEVBQUFBLFlBQVksRUFBRSxzQkFBQTRGLENBQUM7QUFBQSxXQUFLQSxDQUFDLEdBQUdDLE1BQU0sQ0FBQ0QsQ0FBRCxDQUFULEdBQWUsRUFBckI7QUFBQSxHQURLO0FBRXBCL0QsRUFBQUEsUUFBUSxFQUFFLEVBRlU7QUFHcEJLLEVBQUFBLGdCQUFnQixFQUFFLEtBSEU7QUFJcEJrQixFQUFBQSxlQUFlLEVBQUUsR0FKRztBQUtwQm5CLEVBQUFBLGdCQUFnQixFQUFFLEdBTEU7QUFNcEJELEVBQUFBLFVBQVUsRUFBRXRCO0FBTlEsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBQdXJlQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgZnV6emFsZHJpbiBmcm9tICdmdXp6YWxkcmluLXBsdXMnXG5pbXBvcnQgRG93bnNoaWZ0IGZyb20gJ2Rvd25zaGlmdCdcbmltcG9ydCBWaXJ0dWFsTGlzdCBmcm9tICdyZWFjdC10aW55LXZpcnR1YWwtbGlzdCdcbmltcG9ydCB7IFBvcG92ZXIgfSBmcm9tICcuLi8uLi9wb3BvdmVyJ1xuaW1wb3J0IHsgUG9zaXRpb24gfSBmcm9tICcuLi8uLi9jb25zdGFudHMnXG5pbXBvcnQgeyBIZWFkaW5nIH0gZnJvbSAnLi4vLi4vdHlwb2dyYXBoeSdcbmltcG9ydCB7IFBhbmUgfSBmcm9tICcuLi8uLi9sYXllcnMnXG5pbXBvcnQgZGVwcmVjYXRlZCBmcm9tICcuLi8uLi9saWIvZGVwcmVjYXRlZCdcbmltcG9ydCBBdXRvY29tcGxldGVJdGVtIGZyb20gJy4vQXV0b2NvbXBsZXRlSXRlbSdcblxuY29uc3QgZnV6enlGaWx0ZXIgPSBpdGVtVG9TdHJpbmcgPT4ge1xuICBpZiAoaXRlbVRvU3RyaW5nKSB7XG4gICAgcmV0dXJuIChpdGVtcywgaW5wdXQpID0+IHtcbiAgICAgIGNvbnN0IHdyYXBwZWRJdGVtcyA9IGl0ZW1zLm1hcChpdGVtID0+ICh7XG4gICAgICAgIGtleTogaXRlbVRvU3RyaW5nKGl0ZW0pLFxuICAgICAgICBpdGVtXG4gICAgICB9KSlcblxuICAgICAgcmV0dXJuIGZ1enphbGRyaW5cbiAgICAgICAgLmZpbHRlcih3cmFwcGVkSXRlbXMsIGlucHV0LCB7IGtleTogJ2tleScgfSlcbiAgICAgICAgLm1hcCgoeyBpdGVtIH0pID0+IGl0ZW0pXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIChpdGVtcywgaW5wdXQpID0+IGZ1enphbGRyaW4uZmlsdGVyKGl0ZW1zLCBpbnB1dClcbn1cblxuY29uc3Qgbm9vcCA9ICgpID0+IHt9XG5cbmNvbnN0IGF1dG9jb21wbGV0ZUl0ZW1SZW5kZXJlciA9IHByb3BzID0+IDxBdXRvY29tcGxldGVJdGVtIHsuLi5wcm9wc30gLz5cblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL3BheXBhbC9kb3duc2hpZnQvaXNzdWVzLzE2NFxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0b2NvbXBsZXRlIGV4dGVuZHMgUHVyZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLyoqXG4gICAgICogVGhpcyBwcm9wIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb3IgYSBOb2RlLlxuICAgICAqIEl0IHdpbGwgcHJvdmlkZSBhIHRpdGxlIGZvciB0aGUgaXRlbXNcbiAgICAgKi9cbiAgICB0aXRsZTogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnN0cmluZywgUHJvcFR5cGVzLm5vZGVdKSxcblxuICAgIC8qKlxuICAgICAqIEFuIGFycmF5IG9mIGl0ZW1zIHRvIGJlIHVzZWQgYXMgb3B0aW9ucyBmb3IgdGhlIHNlbGVjdFxuICAgICAqL1xuICAgIGl0ZW1zOiBQcm9wVHlwZXMuYXJyYXkuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBzZWxlY3RlZCBJdGVtIHRvIGJlIHNob3duIG9uIHRoZSBhdXRvY29tcGxldGVcbiAgICAgKi9cbiAgICBzZWxlY3RlZEl0ZW06IFByb3BUeXBlcy5hbnksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgc2VsZWN0ZWQgaXRlbSB0byBiZSBzZWxlY3RlZCAmIHNob3duIGJ5IGRlZmF1bHQgb24gdGhlIGF1dG9jb21wbGV0ZSAoZGVwcmVjYXRlZClcbiAgICAgKi9cbiAgICBkZWZhdWx0U2VsZWN0ZWRJdGVtOiBkZXByZWNhdGVkKFxuICAgICAgUHJvcFR5cGVzLmFueSxcbiAgICAgICdVc2UgXCJpbml0aWFsU2VsZWN0ZWRJdGVtXCIgaW5zdGVhZC4nXG4gICAgKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBzZWxlY3RlZCBpdGVtIHRvIGJlIHNlbGVjdGVkICYgc2hvd24gYnkgZGVmYXVsdCBvbiB0aGUgYXV0b2NvbXBsZXRlIChkZXByZWNhdGVkKVxuICAgICAqL1xuICAgIGRlZmF1bHRJbnB1dFZhbHVlOiBkZXByZWNhdGVkKFxuICAgICAgUHJvcFR5cGVzLmFueSxcbiAgICAgICdVc2UgXCJpbml0aWFsSW5wdXRWYWx1ZVwiIGluc3RlYWQuJ1xuICAgICksXG5cbiAgICAvKipcbiAgICAgKiBJbiBjYXNlIHRoZSBhcnJheSBvZiBpdGVtcyBpcyBub3QgYW4gYXJyYXkgb2Ygc3RyaW5ncyxcbiAgICAgKiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgb24gZWFjaCBpdGVtIHRvIHJldHVybiB0aGUgc3RyaW5nIHRoYXQgd2lsbCBiZSBzaG93biBvbiB0aGUgZmlsdGVyXG4gICAgICovXG4gICAgaXRlbVRvU3RyaW5nOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gdGhhdCB3aWxsIHJlbmRlciB0aGUgJ2ZpbHRlcicgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGhlaWdodCBvZiBlYWNoIGl0ZW0gaW4gdGhlIGxpc3RcbiAgICAgKiBCZWNhdXNlIHRoZSBsaXN0IGlzIHZpcnR1YWxpemVkIHRoaXMgaXMgcmVxdWlyZWQgYmVmb3JlaGFuZC5cbiAgICAgKi9cbiAgICBpdGVtU2l6ZTogUHJvcFR5cGVzLm51bWJlcixcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIGNvbXBvbmVudCB0byByZW5kZXIgdGhlIGl0ZW1cbiAgICAgKi9cbiAgICByZW5kZXJJdGVtOiBQcm9wVHlwZXMuZnVuYyxcblxuICAgIC8qKlxuICAgICAqIFRoZSBwb3NpdGlvbiBvZiB0aGUgUG9wb3ZlciB0aGUgQXV0b2NvbXBsZXRlIGlzIHJlbmRlcmVkIGluLlxuICAgICAqL1xuICAgIHBvc2l0aW9uOiBQcm9wVHlwZXMub25lT2YoW1xuICAgICAgUG9zaXRpb24uVE9QLFxuICAgICAgUG9zaXRpb24uVE9QX0xFRlQsXG4gICAgICBQb3NpdGlvbi5UT1BfUklHSFQsXG4gICAgICBQb3NpdGlvbi5CT1RUT00sXG4gICAgICBQb3NpdGlvbi5CT1RUT01fTEVGVCxcbiAgICAgIFBvc2l0aW9uLkJPVFRPTV9SSUdIVCxcbiAgICAgIFBvc2l0aW9uLkxFRlQsXG4gICAgICBQb3NpdGlvbi5SSUdIVFxuICAgIF0pLFxuXG4gICAgLyoqXG4gICAgICogQSBmdW5jdGlvbiB0aGF0IGlzIHVzZWQgdG8gZmlsdGVyIHRoZSBpdGVtcy5cbiAgICAgKiBJdCBzaG91bGQgcmV0dXJuIGEgc3Vic2V0IG9mIHRoZSBpbml0aWFsIGl0ZW1zLlxuICAgICAqIEJ5IGRlZmF1bHQgdGhlIFwiZnV6emFsZHJpbi1wbHVzXCIgcGFja2FnZSBpcyB1c2VkLlxuICAgICAqL1xuICAgIGl0ZW1zRmlsdGVyOiBQcm9wVHlwZXMuZnVuYyxcblxuICAgIC8qKlxuICAgICAqIFByb3AgdGhhdCBlbmFibGVzIGFuZCBkaXNhYmxlcyBmaWx0ZXJpbmdcbiAgICAgKiBUcnVlOiBFbmFibGVzIEZpbHRlcmluZ1xuICAgICAqIEZhbHNlOiBEaXNhYmxlcyBGaWx0ZXJpbmdcbiAgICAgKi9cbiAgICBpc0ZpbHRlckRpc2FibGVkOiBQcm9wVHlwZXMuYm9vbCxcblxuICAgIC8qKlxuICAgICAqIERlZmluZXMgdGhlIG1pbmltdW0gaGVpZ2h0IHRoZSByZXN1bHRzIGNvbnRhaW5lciB3aWxsIGJlXG4gICAgICovXG4gICAgcG9wb3Zlck1pbldpZHRoOiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gICAgLyoqXG4gICAgICogRGVmaW5lcyB0aGUgbWF4aW11bSBoZWlnaHQgdGhlIHJlc3VsdHMgY29udGFpbmVyIHdpbGwgYmVcbiAgICAgKi9cbiAgICBwb3BvdmVyTWF4SGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHNlbGVjdGVkIGl0ZW0gdG8gYmUgc2VsZWN0ZWQgJiBzaG93biBieSBkZWZhdWx0IG9uIHRoZSBhdXRvY29tcGxldGUgKGRlcHJlY2F0ZWQpXG4gICAgICovXG4gICAgZ2V0QnV0dG9uUHJvcHM6IGRlcHJlY2F0ZWQoXG4gICAgICBQcm9wVHlwZXMuZnVuYyxcbiAgICAgICdVc2UgXCJnZXRUb2dnbGVCdXR0b25Qcm9wc1wiIGluc3RlYWQuJ1xuICAgICksXG5cbiAgICAuLi5Eb3duc2hpZnQucHJvcFR5cGVzXG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICB0YXJnZXRXaWR0aDogMFxuICB9XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBpdGVtVG9TdHJpbmc6IGkgPT4gKGkgPyBTdHJpbmcoaSkgOiAnJyksXG4gICAgaXRlbVNpemU6IDMyLFxuICAgIGlzRmlsdGVyRGlzYWJsZWQ6IGZhbHNlLFxuICAgIHBvcG92ZXJNaW5XaWR0aDogMjQwLFxuICAgIHBvcG92ZXJNYXhIZWlnaHQ6IDI0MCxcbiAgICByZW5kZXJJdGVtOiBhdXRvY29tcGxldGVJdGVtUmVuZGVyZXJcbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgdGFyZ2V0V2lkdGg6IHRoaXMudGFyZ2V0UmVmLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRlUmVkdWNlciA9IChzdGF0ZSwgY2hhbmdlcykgPT4ge1xuICAgIGNvbnN0IHsgaXRlbXMgfSA9IHRoaXMucHJvcHNcblxuICAgIGlmIChcbiAgICAgIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjaGFuZ2VzLCAnaXNPcGVuJykgJiZcbiAgICAgIGNoYW5nZXMuaXNPcGVuXG4gICAgKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5jaGFuZ2VzLFxuICAgICAgICBoaWdobGlnaHRlZEluZGV4OiBpdGVtcy5pbmRleE9mKHN0YXRlLnNlbGVjdGVkSXRlbSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY2hhbmdlc1xuICB9XG5cbiAgcmVuZGVyUmVzdWx0cyA9ICh7XG4gICAgd2lkdGgsXG4gICAgaW5wdXRWYWx1ZSxcbiAgICBoaWdobGlnaHRlZEluZGV4LFxuICAgIHNlbGVjdGVkSXRlbSxcbiAgICBnZXRJdGVtUHJvcHMsXG4gICAgZ2V0TWVudVByb3BzXG4gIH0pID0+IHtcbiAgICBjb25zdCB7XG4gICAgICB0aXRsZSxcbiAgICAgIGl0ZW1TaXplLFxuICAgICAgaXRlbXNGaWx0ZXIsXG4gICAgICBpdGVtczogb3JpZ2luYWxJdGVtcyxcbiAgICAgIGl0ZW1Ub1N0cmluZyxcbiAgICAgIHJlbmRlckl0ZW0sXG4gICAgICBwb3BvdmVyTWF4SGVpZ2h0LFxuICAgICAgaXNGaWx0ZXJEaXNhYmxlZFxuICAgIH0gPSB0aGlzLnByb3BzXG5cbiAgICBjb25zdCBmaWx0ZXIgPSBpdGVtc0ZpbHRlciB8fCBmdXp6eUZpbHRlcihpdGVtVG9TdHJpbmcpXG4gICAgY29uc3QgaXRlbXMgPVxuICAgICAgaXNGaWx0ZXJEaXNhYmxlZCB8fCBpbnB1dFZhbHVlLnRyaW0oKSA9PT0gJydcbiAgICAgICAgPyBvcmlnaW5hbEl0ZW1zXG4gICAgICAgIDogZmlsdGVyKG9yaWdpbmFsSXRlbXMsIGlucHV0VmFsdWUpXG5cbiAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbFxuXG4gICAgLy8gUGFzcyB0aGUgYWN0dWFsIERPTSByZWYgdG8gZG93bnNoaWZ0LCB0aGlzIGZpeGVzIHRvdWNoIHN1cHBvcnRcbiAgICBjb25zdCBtZW51UHJvcHMgPSBnZXRNZW51UHJvcHMoKVxuICAgIG1lbnVQcm9wcy5pbm5lclJlZiA9IG1lbnVQcm9wcy5yZWZcbiAgICBkZWxldGUgbWVudVByb3BzLnJlZlxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxQYW5lIHdpZHRoPXt3aWR0aH0gey4uLm1lbnVQcm9wc30+XG4gICAgICAgIHt0aXRsZSAmJiAoXG4gICAgICAgICAgPFBhbmUgcGFkZGluZz17OH0gYm9yZGVyQm90dG9tPVwibXV0ZWRcIj5cbiAgICAgICAgICAgIDxIZWFkaW5nIHNpemU9ezEwMH0+e3RpdGxlfTwvSGVhZGluZz5cbiAgICAgICAgICA8L1BhbmU+XG4gICAgICAgICl9XG4gICAgICAgIHtpdGVtcy5sZW5ndGggPiAwICYmIChcbiAgICAgICAgICA8VmlydHVhbExpc3RcbiAgICAgICAgICAgIHdpZHRoPVwiMTAwJVwiXG4gICAgICAgICAgICBoZWlnaHQ9e01hdGgubWluKGl0ZW1zLmxlbmd0aCAqIGl0ZW1TaXplLCBwb3BvdmVyTWF4SGVpZ2h0KX1cbiAgICAgICAgICAgIGl0ZW1TaXplPXtpdGVtU2l6ZX1cbiAgICAgICAgICAgIGl0ZW1Db3VudD17aXRlbXMubGVuZ3RofVxuICAgICAgICAgICAgc2Nyb2xsVG9JbmRleD17aGlnaGxpZ2h0ZWRJbmRleCB8fCAwfVxuICAgICAgICAgICAgb3ZlcnNjYW5Db3VudD17M31cbiAgICAgICAgICAgIHNjcm9sbFRvQWxpZ25tZW50PVwiYXV0b1wiXG4gICAgICAgICAgICByZW5kZXJJdGVtPXsoeyBpbmRleCwgc3R5bGUgfSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBpdGVtID0gaXRlbXNbaW5kZXhdXG4gICAgICAgICAgICAgIGNvbnN0IGl0ZW1TdHJpbmcgPSBpdGVtVG9TdHJpbmcoaXRlbSlcblxuICAgICAgICAgICAgICByZXR1cm4gcmVuZGVySXRlbShcbiAgICAgICAgICAgICAgICBnZXRJdGVtUHJvcHMoe1xuICAgICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICAgIGtleTogaXRlbVN0cmluZyxcbiAgICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgICAgICAgICBjaGlsZHJlbjogaXRlbVN0cmluZyxcbiAgICAgICAgICAgICAgICAgIGlzU2VsZWN0ZWQ6IGl0ZW1Ub1N0cmluZyhzZWxlY3RlZEl0ZW0pID09PSBpdGVtU3RyaW5nLFxuICAgICAgICAgICAgICAgICAgaXNIaWdobGlnaHRlZDogaGlnaGxpZ2h0ZWRJbmRleCA9PT0gaW5kZXhcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICA8L1BhbmU+XG4gICAgKVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIGNoaWxkcmVuLFxuICAgICAgaXRlbVNpemUsXG4gICAgICBwb3NpdGlvbixcbiAgICAgIHJlbmRlckl0ZW0sXG4gICAgICBpdGVtc0ZpbHRlcixcbiAgICAgIHBvcG92ZXJNYXhIZWlnaHQsXG4gICAgICBwb3BvdmVyTWluV2lkdGgsXG4gICAgICBkZWZhdWx0U2VsZWN0ZWRJdGVtLCAvLyBEZXByZWNhdGVkXG4gICAgICBpbml0aWFsU2VsZWN0ZWRJdGVtLFxuICAgICAgZGVmYXVsdElucHV0VmFsdWUsIC8vIERlcHJlY2F0ZWRcbiAgICAgIGluaXRpYWxJbnB1dFZhbHVlLFxuICAgICAgZ2V0QnV0dG9uUHJvcHMsIC8vIERlcHJlY2F0ZWRcbiAgICAgIGdldFRvZ2dsZUJ1dHRvblByb3BzLFxuICAgICAgLi4ucHJvcHNcbiAgICB9ID0gdGhpcy5wcm9wc1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxEb3duc2hpZnRcbiAgICAgICAgaW5pdGlhbFNlbGVjdGVkSXRlbT17aW5pdGlhbFNlbGVjdGVkSXRlbSB8fCBkZWZhdWx0U2VsZWN0ZWRJdGVtfVxuICAgICAgICBpbml0aWFsSW5wdXRWYWx1ZT17aW5pdGlhbElucHV0VmFsdWUgfHwgZGVmYXVsdElucHV0VmFsdWV9XG4gICAgICAgIGdldFRvZ2dsZUJ1dHRvblByb3BzPXtnZXRUb2dnbGVCdXR0b25Qcm9wcyB8fCBnZXRCdXR0b25Qcm9wc31cbiAgICAgICAgc3RhdGVSZWR1Y2VyPXt0aGlzLnN0YXRlUmVkdWNlcn1cbiAgICAgICAgc2Nyb2xsSW50b1ZpZXc9e25vb3B9XG4gICAgICAgIHsuLi5wcm9wc31cbiAgICAgID5cbiAgICAgICAgeyh7XG4gICAgICAgICAgaXNPcGVuOiBpc1Nob3duLFxuICAgICAgICAgIGlucHV0VmFsdWUsXG4gICAgICAgICAgZ2V0SXRlbVByb3BzLFxuICAgICAgICAgIGdldE1lbnVQcm9wcyxcbiAgICAgICAgICBzZWxlY3RlZEl0ZW0sXG4gICAgICAgICAgaGlnaGxpZ2h0ZWRJbmRleCxcbiAgICAgICAgICBnZXRSb290UHJvcHMsXG4gICAgICAgICAgLi4ucmVzdERvd25zaGlmdFByb3BzXG4gICAgICAgIH0pID0+IChcbiAgICAgICAgICA8UGFuZSB3aWR0aD1cIjEwMCVcIiB7Li4uZ2V0Um9vdFByb3BzKHsgcmVmS2V5OiAnaW5uZXJSZWYnIH0pfT5cbiAgICAgICAgICAgIDxQb3BvdmVyXG4gICAgICAgICAgICAgIGJyaW5nRm9jdXNJbnNpZGU9e2ZhbHNlfVxuICAgICAgICAgICAgICBpc1Nob3duPXtpc1Nob3dufVxuICAgICAgICAgICAgICBtaW5XaWR0aD17cG9wb3Zlck1pbldpZHRofVxuICAgICAgICAgICAgICBwb3NpdGlvbj17XG4gICAgICAgICAgICAgICAgcG9zaXRpb24gfHxcbiAgICAgICAgICAgICAgICAodGhpcy5zdGF0ZS50YXJnZXRXaWR0aCA8IHBvcG92ZXJNaW5XaWR0aFxuICAgICAgICAgICAgICAgICAgPyBQb3NpdGlvbi5CT1RUT01fTEVGVFxuICAgICAgICAgICAgICAgICAgOiBQb3NpdGlvbi5CT1RUT00pXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29udGVudD17KCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbmRlclJlc3VsdHMoe1xuICAgICAgICAgICAgICAgICAgd2lkdGg6IE1hdGgubWF4KHRoaXMuc3RhdGUudGFyZ2V0V2lkdGgsIHBvcG92ZXJNaW5XaWR0aCksXG4gICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlLFxuICAgICAgICAgICAgICAgICAgZ2V0SXRlbVByb3BzLFxuICAgICAgICAgICAgICAgICAgZ2V0TWVudVByb3BzLFxuICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJdGVtLFxuICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0ZWRJbmRleFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgIG1pbkhlaWdodD17MH1cbiAgICAgICAgICAgICAgYW5pbWF0aW9uRHVyYXRpb249ezB9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIHsoeyBpc1Nob3duOiBpc1Nob3duUG9wb3ZlciwgdG9nZ2xlLCBnZXRSZWYgfSkgPT5cbiAgICAgICAgICAgICAgICBjaGlsZHJlbih7XG4gICAgICAgICAgICAgICAgICBpc1Nob3duOiBpc1Nob3duUG9wb3ZlcixcbiAgICAgICAgICAgICAgICAgIHRvZ2dsZSxcbiAgICAgICAgICAgICAgICAgIGdldFJlZjogcmVmID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVXNlIHRoZSByZWYgaW50ZXJuYWxseSB0byBkZXRlcm1pbmUgdGhlIHdpZHRoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UmVmID0gcmVmXG4gICAgICAgICAgICAgICAgICAgIGdldFJlZihyZWYpXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZSxcbiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbSxcbiAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodGVkSW5kZXgsXG4gICAgICAgICAgICAgICAgICAuLi5yZXN0RG93bnNoaWZ0UHJvcHNcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA8L1BvcG92ZXI+XG4gICAgICAgICAgPC9QYW5lPlxuICAgICAgICApfVxuICAgICAgPC9Eb3duc2hpZnQ+XG4gICAgKVxuICB9XG59XG4iXX0=